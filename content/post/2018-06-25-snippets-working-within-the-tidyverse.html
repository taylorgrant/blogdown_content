---
title: 'Snippets: Working within the tidyverse'
author: ''
date: '2019-09-20'
categories:
  - R
tags:
  - dplyr
  - tidy data
  - tidyverse
slug: snippets-working-within-the-tidyverse
summary: Commands, tips, and tricks that are useful within the tidyverse of packages,
  especially when using piped operations.
output:
  blogdown::html_page:
    toc: yes
thumbnailImagePosition: left
thumbnailImage: https://res.cloudinary.com/dn83gtg0l/image/upload/v1548271167/snippets.jpg
---


<div id="TOC">
<ul>
<li><a href="#using-setnames-to-change-column-names">Using setNames to change column names</a></li>
<li><a href="#using-rename_at-to-rename-specific-columns">Using rename_at to rename specific columns</a></li>
<li><a href="#mutate-and-summarise-multiple-columns">Mutate and Summarise multiple columns</a></li>
<li><a href="#mutating-multiple-date-formats-within-the-same-column">Mutating multiple date formats within the same column</a></li>
<li><a href="#multiple-left_joins-using-dplyr">Multiple left_joins using dplyr</a></li>
<li><a href="#calculating-quantiles-the-tidy-way">Calculating quantiles the tidy way</a></li>
<li><a href="#selection-of-multiple-variables">Selection of multiple variables</a></li>
<li><a href="#dplyr---group_split-function">dplyr - group_split function</a></li>
<li><a href="#piping-into-a-t.test">Piping into a t.test</a></li>
</ul>
</div>

<p>Snippet files are periodically updated with tips and tricks as I learn them. These commands are relevant for packages within the <code>tidyverse</code>.</p>
<div id="using-setnames-to-change-column-names" class="section level1">
<h1>Using setNames to change column names</h1>
<p>The <code>colnames</code> function can be used, as can <code>rename()</code>, but for ease of use while piping commands, the <code>setNames()</code> function is the easiest. You can either reference a vector of names or you can also reference a specific row within the data if that’s necessary. For example, in <a href="https://taylorgrant.netlify.com/2018/05/using-rvest-to-import-and-html-table/" target="_blank">this post</a> after scraping an html table the column names were in the second row. In that case, we can just reference the row by its location - <code>%&gt;% setNames(.[2,])</code></p>
<pre class="r"><code>names &lt;- c(&quot;name1&quot;, &quot;name2&quot;, &quot;name3&quot;, &quot;name4&quot;)

df &lt;- tibble(
  a = sample(letters, 4),
  b = sample(1:100, 4),
  c = sample(1:100, 4),
  d = sample(letters, 4)
)

df %&gt;% setNames(names)</code></pre>
<pre><code>## # A tibble: 4 x 4
##   name1 name2 name3 name4
##   &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt;
## 1 m        70    84 q    
## 2 g        84    87 c    
## 3 k        89    34 k    
## 4 l        24    81 n</code></pre>
</div>
<div id="using-rename_at-to-rename-specific-columns" class="section level1">
<h1>Using rename_at to rename specific columns</h1>
<p>Occasionally, you’ll only want to rename certain columns and the <code>rename_at</code> function offers this capability, in much the same way as <code>mutate_at</code> or <code>summarise_at</code>.</p>
<pre class="r"><code>df &lt;- tibble(
  a = sample(letters, 4),
  b = sample(1:100, 4),
  c = sample(1:100, 4),
  d = sample(letters, 4)
)

df &lt;- df %&gt;% 
  rename_at(vars(b,d), ~ paste0(&quot;pastedName_&quot;, .))
df</code></pre>
<pre><code>## # A tibble: 4 x 4
##   a     pastedName_b     c pastedName_d
##   &lt;chr&gt;        &lt;int&gt; &lt;int&gt; &lt;chr&gt;       
## 1 m               15    24 x           
## 2 g               88    66 b           
## 3 d               74    40 r           
## 4 n               87     9 w</code></pre>
</div>
<div id="mutate-and-summarise-multiple-columns" class="section level1">
<h1>Mutate and Summarise multiple columns</h1>
<p>This is well summarised <a href="https://dplyr.tidyverse.org/reference/summarise_all.html" target="_blank">here</a>, but a few examples are below. When using either <code>mutate_at()</code> or <code>summarise_at</code> it’s important to include the “vars(), funs()” format.</p>
<pre class="r"><code>mtcars %&gt;% 
  group_by(cyl) %&gt;%
  summarise_at(vars(disp, drat, mpg), funs(median, mean))</code></pre>
<pre><code>## Warning: funs() is soft deprecated as of dplyr 0.8.0
## Please use a list of either functions or lambdas: 
## 
##   # Simple named list: 
##   list(mean = mean, median = median)
## 
##   # Auto named with `tibble::lst()`: 
##   tibble::lst(mean, median)
## 
##   # Using lambdas
##   list(~ mean(., trim = .2), ~ median(., na.rm = TRUE))
## This warning is displayed once per session.</code></pre>
<pre><code>## # A tibble: 3 x 7
##     cyl disp_median drat_median mpg_median disp_mean drat_mean mpg_mean
##   &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
## 1     4        108         4.08       26        105.      4.07     26.7
## 2     6        168.        3.9        19.7      183.      3.59     19.7
## 3     8        350.        3.12       15.2      353.      3.23     15.1</code></pre>
<p>The <a href="https://dplyr.tidyverse.org/reference/select_helpers.html" target="_blank">helper functions</a> for <code>select()</code> are also useful for selecting variables. Though note that when using helpers such as <code>contains()</code> that you can only include one string. For instance, this will work.</p>
<pre class="r"><code>mtcars %&gt;% 
  summarise_at(vars(contains(&quot;ar&quot;)), funs(mean))</code></pre>
<pre><code>##     gear   carb
## 1 3.6875 2.8125</code></pre>
<p>But this won’t</p>
<pre class="r"><code>mtcars %&gt;%
  summarise_at(vars(contains(&quot;ar|mp&quot;)), funs(mean))</code></pre>
<pre><code>## data frame with 0 columns and 1 row</code></pre>
<p>If you want to match across multiple strings, the <code>matches()</code> function will do the trick.</p>
<pre class="r"><code>mtcars %&gt;%
  summarise_at(vars(matches(&quot;ar|mp&quot;)), funs(mean))</code></pre>
<pre><code>##        mpg   gear   carb
## 1 20.09062 3.6875 2.8125</code></pre>
</div>
<div id="mutating-multiple-date-formats-within-the-same-column" class="section level1">
<h1>Mutating multiple date formats within the same column</h1>
<p>I was recently dealing with several large datasets that contain multiple date formats. I had been trying to set the dates as <code>as.POSIXct</code> formats, and it wasn’t until trying to use the <code>difftime</code> function that I realized several years were in two digit, rather than four digit format. The problem is that when specifying the date format, a two digit year pads itself with two extra zeros as seen below in the try_date column.</p>
<pre class="r"><code>df &lt;- tibble(
  dates = c(&quot;30/05/2017 07:20&quot;, &quot;19/6/17 13:47&quot;)
)

df %&gt;% mutate(try_date = as.POSIXct(dates, tz = &quot;&quot;, format = &quot;%d/%m/%Y %H:%M&quot;))</code></pre>
<pre><code>## # A tibble: 2 x 2
##   dates            try_date           
##   &lt;chr&gt;            &lt;dttm&gt;             
## 1 30/05/2017 07:20 2017-05-30 07:20:00
## 2 19/6/17 13:47    0017-06-19 13:47:00</code></pre>
<p>To get around this, we can use the <code>lubridate</code> package to solve our issues. In this case, I’m splitting out my dates and times before gluing them back together. the <code>dmy()</code> function automatically converts the <code>%y</code> into <code>%Y</code>.</p>
<pre class="r"><code>df &lt;- tibble(
  dates = c(&quot;30/05/2017 07:20&quot;, &quot;19/6/17 13:47&quot;)
)

df %&gt;% 
  mutate(working_date = lubridate::dmy(gsub(&quot;\\ .*&quot;, &quot;&quot;, dates)),
         hour = gsub(&quot;.*\\ &quot;, &quot;&quot;, dates),
         final_date = as.POSIXct(glue(&quot;{working_date} {hour}&quot;), tz=&quot;&quot;, format = &quot;%Y-%m-%d %H:%M&quot;))</code></pre>
<pre><code>## # A tibble: 2 x 4
##   dates            working_date hour  final_date         
##   &lt;chr&gt;            &lt;date&gt;       &lt;chr&gt; &lt;dttm&gt;             
## 1 30/05/2017 07:20 2017-05-30   07:20 2017-05-30 07:20:00
## 2 19/6/17 13:47    2017-06-19   13:47 2017-06-19 13:47:00</code></pre>
</div>
<div id="multiple-left_joins-using-dplyr" class="section level1">
<h1>Multiple left_joins using dplyr</h1>
<p>It’s always possible to use multiple <code>left_join</code> functions, but the easiest way to do merge multiple data sets together may be to put everything into a list and then use the <code>Reduce</code> function. I had used <code>map</code> to work over a lot of data, so everything was in a list. I then took the data I wanted to use as my base and concatenated it to the list.</p>
<pre><code>tmp &lt;- c(list(df), original_list)</code></pre>
<p>Then, using dplyr commands was able to join all of the data. In this case, my original list had 30 separate dataframes.</p>
<pre><code>mass_df &lt;- tmp %&gt;% Reduce(function(df1, df2), left_join(df1, df2), .)</code></pre>
<p>The <code>left_join</code> command can be further defined to specify what we’re joining by, or to select only specific columns that will be joined.</p>
<pre><code># using &quot;matches&quot; to pull out specific variables
mass_df &lt;- tmp %&gt;% Reduce(function(df1, df2), left_join(df1, select(df2, matches(&quot;avar|bvar&quot;))), .)

# specifying what the join is by
mass_df &lt;- tmp %&gt;% Reduce(function(df1, df2), left_join(df1, df2, by = &quot;index&quot;), .)</code></pre>
</div>
<div id="calculating-quantiles-the-tidy-way" class="section level1">
<h1>Calculating quantiles the tidy way</h1>
<p>This is straight from Stack Overflow, but comes in handy. Note that “probs” can be added to the <code>quantile</code> command depending on specific needs.</p>
<pre class="r"><code>mtcars %&gt;%
  nest(-cyl) %&gt;% 
  mutate(quantiles = map(data, ~ quantile(.$mpg))) %&gt;%
  unnest(map(quantiles, broom::tidy))</code></pre>
<pre><code>## Warning: &#39;tidy.numeric&#39; is deprecated.
## See help(&quot;Deprecated&quot;)

## Warning: &#39;tidy.numeric&#39; is deprecated.
## See help(&quot;Deprecated&quot;)

## Warning: &#39;tidy.numeric&#39; is deprecated.
## See help(&quot;Deprecated&quot;)</code></pre>
<pre><code>## # A tibble: 15 x 3
##      cyl names     x
##    &lt;dbl&gt; &lt;chr&gt; &lt;dbl&gt;
##  1     6 0%     17.8
##  2     6 25%    18.6
##  3     6 50%    19.7
##  4     6 75%    21  
##  5     6 100%   21.4
##  6     4 0%     21.4
##  7     4 25%    22.8
##  8     4 50%    26  
##  9     4 75%    30.4
## 10     4 100%   33.9
## 11     8 0%     10.4
## 12     8 25%    14.4
## 13     8 50%    15.2
## 14     8 75%    16.2
## 15     8 100%   19.2</code></pre>
</div>
<div id="selection-of-multiple-variables" class="section level1">
<h1>Selection of multiple variables</h1>
<p>When using either <code>select</code> or wanting to <code>mutate_at</code> there are lots of helpers – <code>starts_with</code>, <code>ends_with</code>, <code>contains</code>, and <code>matches</code> and probably some that I’m missing.</p>
<p><code>contains</code> only works on a single, specific request, whereas <code>matches</code> allows for an OR.</p>
<pre class="r"><code>tmp &lt;- tibble(g1_letters = sample(letters, 5), 
              g1_num = sample(1:600000, 5),
              g2_letters = sample(letters, 5),
              g2_num = sample(1:60000, 5),
              h1_letters = sample(letters, 5),
              h1_num = sample(1:60000, 5))

# or statement
tmp &lt;- tmp %&gt;% select(matches(&quot;g1|h1&quot;))
tmp</code></pre>
<pre><code>## # A tibble: 5 x 4
##   g1_letters g1_num h1_letters h1_num
##   &lt;chr&gt;       &lt;int&gt; &lt;chr&gt;       &lt;int&gt;
## 1 p          566683 z           10588
## 2 k          193392 p           51402
## 3 i          402277 o            5115
## 4 n          463562 j           29912
## 5 a          199700 x            7870</code></pre>
<p>But we can also use the <code>intersect</code> function to create an AND statement</p>
<pre class="r"><code>tmp &lt;- tibble(g1_letters = sample(letters, 5), 
              g1_num = sample(1:600000, 5),
              g1_weighted = g1_num*.4,
              g2_letters = sample(letters, 5),
              g2_num = sample(1:60000, 5),
              g2_weighted = g2_num*.4,
              h1_letters = sample(letters, 5),
              h1_num = sample(1:60000, 5),
              h1_weighted = h1_num*.4)

tmp &lt;- tmp %&gt;% 
  summarise_at(vars(matches(&quot;num|weighted&quot;)), sum) %&gt;%
  mutate_at(vars(intersect(starts_with(&quot;g1&quot;), contains(&quot;weighted&quot;))), 
            funs(paste0(., &quot;sel&quot;)))
tmp</code></pre>
<pre><code>## # A tibble: 1 x 6
##    g1_num g1_weighted g2_num g2_weighted h1_num h1_weighted
##     &lt;int&gt; &lt;chr&gt;        &lt;int&gt;       &lt;dbl&gt;  &lt;int&gt;       &lt;dbl&gt;
## 1 1503290 601316sel   204668      81867. 156813      62725.</code></pre>
</div>
<div id="dplyr---group_split-function" class="section level1">
<h1>dplyr - group_split function</h1>
<p>An interesting addition to dplyr is the new <code>group_split</code> function which groups by a specific variable and then splits the data into separate lists.</p>
<p>Not sure when I’m going to use this, but wanted to put it here.</p>
<pre class="r"><code>pacman::p_load(tidyverse)
data(starwars)

split_by &lt;- starwars %&gt;%
  group_by(gender)

group_split(split_by)</code></pre>
<pre><code>## [[1]]
## # A tibble: 19 x 13
##    name  height  mass hair_color skin_color eye_color birth_year gender
##    &lt;chr&gt;  &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; 
##  1 Leia…    150  49   brown      light      brown             19 female
##  2 Beru…    165  75   brown      light      blue              47 female
##  3 Mon …    150  NA   auburn     fair       blue              48 female
##  4 Shmi…    163  NA   black      fair       brown             72 female
##  5 Ayla…    178  55   none       blue       hazel             48 female
##  6 Adi …    184  50   none       dark       blue              NA female
##  7 Cordé    157  NA   brown      light      brown             NA female
##  8 Lumi…    170  56.2 black      yellow     blue              58 female
##  9 Barr…    166  50   black      yellow     blue              40 female
## 10 Dormé    165  NA   brown      light      brown             NA female
## 11 Zam …    168  55   blonde     fair, gre… yellow            NA female
## 12 Taun…    213  NA   none       grey       black             NA female
## 13 Joca…    167  NA   white      fair       blue              NA female
## 14 R4-P…     96  NA   none       silver, r… red, blue         NA female
## 15 Shaa…    178  57   none       red, blue… black             NA female
## 16 Sly …    178  48   none       pale       white             NA female
## 17 Rey       NA  NA   brown      light      hazel             NA female
## 18 Capt…     NA  NA   unknown    unknown    unknown           NA female
## 19 Padm…    165  45   brown      light      brown             46 female
## # … with 5 more variables: homeworld &lt;chr&gt;, species &lt;chr&gt;, films &lt;list&gt;,
## #   vehicles &lt;list&gt;, starships &lt;list&gt;
## 
## [[2]]
## # A tibble: 1 x 13
##   name  height  mass hair_color skin_color eye_color birth_year gender
##   &lt;chr&gt;  &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; 
## 1 Jabb…    175  1358 &lt;NA&gt;       green-tan… orange           600 herma…
## # … with 5 more variables: homeworld &lt;chr&gt;, species &lt;chr&gt;, films &lt;list&gt;,
## #   vehicles &lt;list&gt;, starships &lt;list&gt;
## 
## [[3]]
## # A tibble: 62 x 13
##    name  height  mass hair_color skin_color eye_color birth_year gender
##    &lt;chr&gt;  &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; 
##  1 Luke…    172    77 blond      fair       blue            19   male  
##  2 Dart…    202   136 none       white      yellow          41.9 male  
##  3 Owen…    178   120 brown, gr… light      blue            52   male  
##  4 Bigg…    183    84 black      light      brown           24   male  
##  5 Obi-…    182    77 auburn, w… fair       blue-gray       57   male  
##  6 Anak…    188    84 blond      fair       blue            41.9 male  
##  7 Wilh…    180    NA auburn, g… fair       blue            64   male  
##  8 Chew…    228   112 brown      unknown    blue           200   male  
##  9 Han …    180    80 brown      fair       brown           29   male  
## 10 Gree…    173    74 &lt;NA&gt;       green      black           44   male  
## # … with 52 more rows, and 5 more variables: homeworld &lt;chr&gt;,
## #   species &lt;chr&gt;, films &lt;list&gt;, vehicles &lt;list&gt;, starships &lt;list&gt;
## 
## [[4]]
## # A tibble: 2 x 13
##   name  height  mass hair_color skin_color eye_color birth_year gender
##   &lt;chr&gt;  &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; 
## 1 IG-88    200   140 none       metal      red               15 none  
## 2 BB8       NA    NA none       none       black             NA none  
## # … with 5 more variables: homeworld &lt;chr&gt;, species &lt;chr&gt;, films &lt;list&gt;,
## #   vehicles &lt;list&gt;, starships &lt;list&gt;
## 
## [[5]]
## # A tibble: 3 x 13
##   name  height  mass hair_color skin_color eye_color birth_year gender
##   &lt;chr&gt;  &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; 
## 1 C-3PO    167    75 &lt;NA&gt;       gold       yellow           112 &lt;NA&gt;  
## 2 R2-D2     96    32 &lt;NA&gt;       white, bl… red               33 &lt;NA&gt;  
## 3 R5-D4     97    32 &lt;NA&gt;       white, red red               NA &lt;NA&gt;  
## # … with 5 more variables: homeworld &lt;chr&gt;, species &lt;chr&gt;, films &lt;list&gt;,
## #   vehicles &lt;list&gt;, starships &lt;list&gt;
## 
## attr(,&quot;ptype&quot;)
## # A tibble: 0 x 13
## # … with 13 variables: name &lt;chr&gt;, height &lt;int&gt;, mass &lt;dbl&gt;,
## #   hair_color &lt;chr&gt;, skin_color &lt;chr&gt;, eye_color &lt;chr&gt;, birth_year &lt;dbl&gt;,
## #   gender &lt;chr&gt;, homeworld &lt;chr&gt;, species &lt;chr&gt;, films &lt;list&gt;,
## #   vehicles &lt;list&gt;, starships &lt;list&gt;</code></pre>
</div>
<div id="piping-into-a-t.test" class="section level1">
<h1>Piping into a t.test</h1>
<pre class="r"><code>tibble(a = c(rnorm(100, mean = 50, sd = 5),rnorm(100, mean = 80, sd = 5)),
       group = c(rep(&quot;green&quot;, 100), rep(&quot;blue&quot;, 100))) %&gt;%
  t.test(a ~ group, data = ., var.equal = TRUE)</code></pre>
<pre><code>## 
##  Two Sample t-test
## 
## data:  a by group
## t = 42.537, df = 198, p-value &lt; 2.2e-16
## alternative hypothesis: true difference in means is not equal to 0
## 95 percent confidence interval:
##  28.61222 31.39409
## sample estimates:
##  mean in group blue mean in group green 
##            79.94385            49.94069</code></pre>
</div>
