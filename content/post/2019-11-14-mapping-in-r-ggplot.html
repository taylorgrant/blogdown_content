---
title: Mapping in R (ggplot)
author: ''
date: '2019-11-14'
slug: mapping-in-r-ggplot
categories:
  - R
  - lesson
  - mapping
tags:
  - ggplot
  - mapping
thumbnailImagePosition: left
thumbnailImage: https://res.cloudinary.com/dn83gtg0l/image/upload/v1573751968/old-map.png
summary: "Various maps made in R"
output:
  blogdown::html_page:
    toc: true
---


<div id="TOC">
<ul>
<li><a href="#packages-used">Packages used:</a></li>
<li><a href="#get-the-data-necessary">Get the data necessary</a></li>
<li><a href="#map-at-the-state-level">Map at the state level</a></li>
<li><a href="#map-at-the-county-level">Map at the County Level</a></li>
<li><a href="#specific-to-a-state">Specific to a state</a></li>
<li><a href="#geofacet-map">Geofacet map</a></li>
<li><a href="#hexmaps">Hexmaps</a></li>
</ul>
</div>

<div id="packages-used" class="section level2">
<h2>Packages used:</h2>
<p>This is using the <code>urbnmapr</code> <a href="https://medium.com/@urban_institute/how-to-create-state-and-county-maps-easily-in-r-577d29300bb2" target="_blank">package</a> for state and county choropleth maps.</p>
<pre class="r"><code>devtools::install_github(“UrbanInstitute/urbnmapr”)
pacman::p_load(tidyverse, urbnmapr, geofacet, readxl, httr, geofacet)</code></pre>
<p>At the state level, let’s map data on the change in the cost of housing using the Housing Price Index from Freddie Mac.</p>
</div>
<div id="get-the-data-necessary" class="section level2">
<h2>Get the data necessary</h2>
<pre class="r"><code># download house price data (Freddie Mac)
dt &lt;- data.table::fread(&quot;http://www.freddiemac.com/fmac-resources/research/docs/fmhpi_master_file.csv&quot;)
# get CPI data (FRED)
df_cpi &lt;- tidyquant::tq_get(&quot;CUUR0000SA0L2&quot;,get=&quot;economic.data&quot;,from=&quot;1975-01-01&quot;)
# get delineation file (use April 2018 version)
url1 &lt;- &quot;https://www2.census.gov/programs-surveys/metro-micro/geographies/reference-files/2018/delineation-files/list1.xls&quot;
GET(url1, write_disk(tf &lt;- tempfile(fileext = &quot;.xls&quot;)))
df &lt;- read_excel(tf,skip=2) #read in data from third row
# get rid of colname spaces
colnames(df) &lt;- gsub(&#39;([[:punct:]])|\\s+&#39;,&#39;_&#39;,names(df))

# Put it together ---------------------------------------------------------
dt &lt;- dt %&gt;% data.frame() %&gt;%
  mutate(date = as.Date(paste0(Year,&quot;-&quot;, Month,&quot;-&quot; ,&quot;1&quot;))) %&gt;% 
  left_join(df_cpi) %&gt;% 
  group_by(GEO_Name, GEO_Type) %&gt;%
  mutate(real_hpi = 100*Index_SA/first(Index_SA) / (price/first(price))) %&gt;% # create real house price index
  ungroup()

dt2 &lt;- dt %&gt;%
  filter(date == max(date) &amp; GEO_Type == &quot;State&quot;) %&gt;% 
  left_join(states, by = c(&quot;GEO_Name&quot; = &quot;state_abbv&quot;))

dt3 &lt;- dt %&gt;% 
  filter(date == max(date) &amp; GEO_Type == &quot;CBSA&quot;) %&gt;%
  left_join(df, by=c(&quot;GEO_Code&quot;=&quot;CBSA_Code&quot;))

# load theme for ggplot 
devtools::source_url(&quot;https://raw.githubusercontent.com/taylorgrant/sandbox/master/theme_twg.R&quot;)</code></pre>
</div>
<div id="map-at-the-state-level" class="section level1">
<h1>Map at the state level</h1>
<pre class="r"><code># graph 
ggplot(subset(dt2, GEO_Name != &quot;DC&quot;), 
       mapping = aes(long, lat, group = group, fill = log(real_hpi))) + 
  geom_polygon(color = &quot;#ffffff&quot;, size = 0) + 
  coord_map(projection = &quot;albers&quot;, lat0 = 39, lat1 = 45) +
  viridis::scale_fill_viridis(option = &quot;E&quot;,
                              breaks=c(log(50),log(100),log(200),log(400)),
                              labels=c(&quot;-50%&quot;,&quot;0%&quot;,&quot;+100%&quot;,&quot;+200%&quot;),
                              limits=c(log(50),log(400))) + 
  theme_twg(grid = FALSE) + 
  theme(legend.title = element_text(),
        axis.text = element_blank(),
        legend.key.width = unit(.2, &#39;in&#39;),
        legend.position = &quot;right&quot;) +
  labs(x = &quot;&quot;, y = &quot;&quot;,
       title = &quot;The coasts have gotten more expensive&quot;,
       caption = &quot;Freddie Mac House Price Index by State,\ndeflated by US BLS, Consumer Price Index&quot;,
       fill = &quot;Real House Price Growth\nSince Jan 1975&quot;)  </code></pre>
<p><img src="/post/2019-11-14-mapping-in-r-ggplot_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
</div>
<div id="map-at-the-county-level" class="section level1">
<h1>Map at the County Level</h1>
<p>Let’s get data on educational achievement at the county level and map it. Again, using the <code>urbnmapr</code> package to bring in the shapefile data.</p>
<pre class="r"><code># get the data and clean 
data(counties)
url1 &lt;- &quot;https://www.ers.usda.gov/webdocs/DataFiles/48747/Education.xls?v=1754.5&quot;
GET(url1, write_disk(tf &lt;- tempfile(fileext = &quot;.xls&quot;)))</code></pre>
<pre><code>## Response [https://www.ers.usda.gov/webdocs/DataFiles/48747/Education.xls?v=1754.5]
##   Date: 2019-11-15 17:59
##   Status: 200
##   Content-Type: application/vnd.ms-excel
##   Size: 1.46 MB
## &lt;ON DISK&gt;  /var/folders/94/ccg99vlx5hn4rhfw5qgqfbvs4jjjx5/T//RtmpSg2lY0/file1685972632252.xls</code></pre>
<pre class="r"><code>ed &lt;- readxl::read_excel(tf,skip=4) %&gt;%
  janitor::clean_names()

ed %&gt;% 
  select(fips_code, state, area_name, percent_of_adults_with_a_bachelors_degree_or_higher_2013_17) %&gt;%
  inner_join(counties, by = c(&quot;fips_code&quot; = &quot;county_fips&quot;)) %&gt;%
  ggplot(mapping = aes(long, lat, group = group, fill = percent_of_adults_with_a_bachelors_degree_or_higher_2013_17)) +
  geom_polygon(data = states, aes(long, lat, group = group), fill = &quot;#f0f0f5&quot;, color = &quot;white&quot;,
               size = 0) + 
  geom_polygon(color = &quot;#ffffff&quot;, size =0) +
  coord_map(projection =&quot;albers&quot;, lat0 = 39, lat1 =45) + 
  viridis::scale_fill_viridis(option = &quot;E&quot;,
                              breaks = seq(20,100,20),
                              labels = c(&quot;20%&quot;,&quot;40%&quot;,&quot;60%&quot;,&quot;80%&quot;,&quot;100%&quot;)) +
  theme_twg(grid = FALSE) + 
  theme(legend.title = element_text(),
        axis.text = element_blank(),
        legend.key.width = unit(.2, &#39;in&#39;),
        legend.position = &quot;right&quot;) +
  labs(x = &quot;&quot;, y = &quot;&quot;,
       title = &quot;The most well educated counties in America (2013-2017)&quot;,
       subtitle = &quot;#1 is Falls Church, VA&quot;,
       caption = &quot;Source: USDA, Economic Research Service&quot;,
       fill = &quot;% Adults 25+ with\nBachelor&#39;s Degree&quot;) </code></pre>
<p><img src="/post/2019-11-14-mapping-in-r-ggplot_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
</div>
<div id="specific-to-a-state" class="section level1">
<h1>Specific to a state</h1>
<p>We can filter down to the state level. Be sure to subset the polygon data…</p>
<pre class="r"><code>data(counties)
url1 &lt;- &quot;https://www.ers.usda.gov/webdocs/DataFiles/48747/Education.xls?v=1754.5&quot;
GET(url1, write_disk(tf &lt;- tempfile(fileext = &quot;.xls&quot;)))</code></pre>
<pre><code>## Response [https://www.ers.usda.gov/webdocs/DataFiles/48747/Education.xls?v=1754.5]
##   Date: 2019-11-15 17:59
##   Status: 200
##   Content-Type: application/vnd.ms-excel
##   Size: 1.46 MB
## &lt;ON DISK&gt;  /var/folders/94/ccg99vlx5hn4rhfw5qgqfbvs4jjjx5/T//RtmpSg2lY0/file168594b1b9e6.xls</code></pre>
<pre class="r"><code>ed &lt;- readxl::read_excel(tf,skip=4) %&gt;%
  janitor::clean_names()

ed %&gt;% 
  select(fips_code, state, area_name, percent_of_adults_with_a_bachelors_degree_or_higher_2013_17) %&gt;%
  inner_join(counties, by = c(&quot;fips_code&quot; = &quot;county_fips&quot;)) %&gt;%
  filter(state_name == &quot;Washington&quot;) %&gt;%
  ggplot(mapping = aes(long, lat, group = group, fill = percent_of_adults_with_a_bachelors_degree_or_higher_2013_17)) +
  geom_polygon(data = subset(states, state_name == &quot;Washington&quot;), aes(long, lat, group = group), fill = &quot;#f0f0f5&quot;, color = &quot;white&quot;,
               size = 0) + 
  geom_polygon(color = &quot;#ffffff&quot;, size =0) +
  coord_map(projection =&quot;albers&quot;, lat0 = 39, lat1 =45) + 
  viridis::scale_fill_viridis(option = &quot;E&quot;,
                              breaks = seq(20,100,20),
                              labels = c(&quot;20%&quot;,&quot;40%&quot;,&quot;60%&quot;,&quot;80%&quot;,&quot;100%&quot;)) +
  theme_twg(grid = FALSE) + 
  theme(legend.title = element_text(),
        axis.text = element_blank(),
        legend.key.width = unit(.2, &#39;in&#39;),
        legend.position = &quot;right&quot;) +
  labs(x = &quot;&quot;, y = &quot;&quot;,
       title = &quot;The most well educated counties in America (2013-2017)&quot;,
       subtitle = &quot;#1 is Falls Church, VA&quot;,
       caption = &quot;Source: USDA, Economic Research Service&quot;,
       fill = &quot;% Adults 25+ with\nBachelor&#39;s Degree&quot;) </code></pre>
<p><img src="/post/2019-11-14-mapping-in-r-ggplot_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
</div>
<div id="geofacet-map" class="section level1">
<h1>Geofacet map</h1>
<p>Map each state as a time series. In this case, looking at net migration flows from each state from 2010-2018.</p>
<pre class="r"><code>ggplot(migration, aes(x=year, y = net, ymin = 0, ymax = net)) +
  geom_line(color = &quot;dodgerblue&quot;) +
  geom_hline(yintercept = 0, col = &quot;black&quot;, linetype = &quot;dotted&quot;) +
  facet_geo(~state, grid = &quot;us_state_grid2&quot;, label = &quot;code&quot;) + # abbrevation rather than name
  scale_x_continuous(breaks = seq(2010,2018,2),
                     labels = seq(10,18,2)) +
  # theme_twg(base_size = 8) + 
  theme_twg() + 
  theme(axis.text = element_text(size = rel(0.75))) +
  hrbrthemes::scale_y_comma() + 
  labs(title = &quot;Net Migration per State 2010-2018&quot;,
       caption = &quot;Source: U.S. Census Bureau, American Community Survey&quot;,
       y = &quot;&quot;, x = &quot;&quot;)</code></pre>
<p><img src="/post/2019-11-14-mapping-in-r-ggplot_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
</div>
<div id="hexmaps" class="section level1">
<h1>Hexmaps</h1>
<pre class="r"><code>pacman::p_load(tidyverse, rgdal, rgeos, rvest)
# download the geojson file from here &quot;https://team.carto.com/u/andrew/tables/andrew.us_states_hexgrid/public/map&quot;
# load the map data 
us &lt;- readOGR(&quot;data/mapping/us_states_hexgrid.geojson&quot;, &quot;OGRGeoJSON&quot;)</code></pre>
<pre class="r"><code>pacman::p_load(tidyverse, rgdal, rgeos, rvest)
# set up the centers and fortify for use in ggplot
centers &lt;- cbind.data.frame(data.frame(gCentroid(us, byid=TRUE), id=us@data$iso3166_2))
us_map &lt;- fortify(us, region = &quot;iso3166_2&quot;)

# grab state names and abbreviations for use after scraping 
library(urbnmapr)
data(states)

states &lt;- states %&gt;% distinct(state_name, .keep_all = TRUE) %&gt;% 
  dplyr::select(state_abbv, state_name)

# scrape a site for data 
url &lt;- &quot;http://worldpopulationreview.com/states/alcohol-consumption-by-state/&quot;
drink &lt;- url %&gt;%
  read_html() %&gt;%
  html_nodes(xpath = &#39;//*[@id=&quot;dataTable&quot;]/div[1]/div/div/div/div/div[2]/table&#39;) %&gt;%
  html_table(header = TRUE) %&gt;% 
  flatten_df() %&gt;% 
  janitor::clean_names() %&gt;% 
  left_join(states, by = c(&quot;state&quot; = &quot;state_name&quot;))

# put data into the map data 
us@data &lt;- us@data %&gt;% 
  left_join(drink, by = c(&quot;iso3166_2&quot; = &quot;state_abbv&quot;))

# plot 
ggplot() + geom_map(data=us_map, map=us_map,
                    aes(x=long, y=lat, map_id=id),
                    color=&quot;white&quot;, size=0.5) +
  geom_map(data=us@data, map=us_map,
                    aes(fill=alcohol_consumption_in_gallons, map_id=iso3166_2)) +
  geom_map(data=us@data, map=us_map,
                    aes(map_id=iso3166_2),
                    fill=&quot;#ffffff&quot;, alpha=0, color=&quot;white&quot;,
                    show.legend=FALSE) +
  geom_text(data=centers, aes(label=id, x=x, y=y), color=&quot;white&quot;, size=3) +
  viridis::scale_fill_viridis(option = &quot;E&quot;, na.value=&quot;#7f7f7f&quot;, trans = &quot;log&quot;,
                              breaks = c(1,2,3,4),
                              labels = c(&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;),
                              name = &quot;Gallons/person&quot;) + 
  coord_map() + 
  theme_twg(grid = FALSE) + 
  theme(axis.text = element_blank()) + 
  labs(x = &quot;&quot;, y = &quot;&quot;,
       title = &quot;Alcohol Consumption by State per Capita, 2019&quot;,
       caption = &quot;Source: World Population Review&quot;)</code></pre>
<p><img src="/post/2019-11-14-mapping-in-r-ggplot_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
</div>
